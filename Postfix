# AUTH ON REMOTE SERVER FROM RELAY

# ## https://www.postfix.org/SASL_README.html

#MTASERVER
# Instalación de paquetes
[root@centos9-mtaserver ~]# dnf install cyrus-sasl cyrus-sasl-lib cyrus-sasl-plain

# Generación de certificado/clave para habilitar TLS
[root@centos9-mtaserver ~]# openssl req -new -x509 -days 3650 -nodes -newkey rsa:2048 -keyout /etc/pki/tls/private/private.key -out /etc/pki/tls/certs/public.crt

# Como lo vamos a configurar con una BD de usuarios independiente a la del sistema (no usamos ni /etc/shadow ni PAM),
# no precisamos tener levantado el servicio saslauth.
#[root@centos9-mtaserver ~]# systemctl enable saslauthd
#[root@centos9-mtaserver ~]# systemctl start saslauthd

# Configuración Postfix
[root@centos9-mtaserver ~]# cat /etc/postfix/main.cf
(.......................................................................)
smtp_host_lookup                = native,dns
cyrus_sasl_config_path          = /etc/sasl2
smtpd_sasl_path                 = smtpd
smtpd_sasl_auth_enable          = yes
smtpd_sasl_security_options     = noanonymous
smtpd_sasl_tls_security_options = $smtpd_sasl_security_options
smtpd_client_restrictions       = permit_sasl_authenticated, reject
smtpd_tls_security_level        = encrypt
smtpd_tls_cert_file             = /etc/pki/tls/certs/public.crt
smtpd_tls_key_file              = /etc/pki/tls/private/private.key

# Configuración SASL para usar "sasldb", una base de datos propia de usuarios.
[root@centos9-mtaserver ~]# cat /etc/sasl2/smtpd.conf
pwcheck_method: auxprop
auxprop_plugin: sasldb
mech_list: PLAIN LOGIN CRAM-MD5 DIGEST-MD5 NTLM

# Creación de usuario en la BD "sasldb" (está todo en el archivo /etc/sasl2/sasldb2).
# Esto creo el usuario "smtpuser@a.com"
[root@centos9-mtaserver ~]# saslpasswd2 -c -u a.com smtpuser
Password: Uruguay2030
Again (for verification): Uruguay2030

# Listado de usuarios existentes (la contraseña nunca se muestra)
[root@centos9-mtaserver ~]# sasldblistusers2
smtpuser@a.com: userPassword

# Ajuste de permisos para que Postfix pueda leer la BD:
[root@centos9-mtaserver ~]# chmod 644 /etc/sasl2/sasldb2

# Aplicamos los cambios
[root@centos9-mtaserver ~]# systemctl restart postfix


-----------
#MTAGATEWAY

# Instalación de paquetes
[root@centos9-mtagateway ~]# dnf install cyrus-sasl cyrus-sasl-lib cyrus-sasl-plain

# Configuración Postfix
[root@centos9-mtagateway ~]#cat /etc/postfix/main.cf
(.......................................................................)
smtp_host_lookup               = native,dns
smtp_sasl_auth_enable          = yes
smtp_tls_security_level        = encrypt
smtp_sasl_tls_security_options = noanonymous
smtp_sasl_password_maps        = hash:/etc/postfix/sasl_passwd

# Si queremos credenciales dependientes del servidor smtp destino (dominio del destinatario)
# * Si no hay usuario para el dominio destino, no se envía autenticado.
# * Si el host va con [nombre], no se hace búsqueda del DNS-MX y se va directo al nombre que aparece.

[root@centos9-mtagateway ~]# cat /etc/postfix/sasl_passwd
# destination                   username:password
a.com                           smtpuser@a.com:Uruguay2030
#[mail.a.com]                   smtpuser@a.com:Uruguay2030

[root@centos9-mtagateway ~]# postmap /etc/postfix/sasl_passwd
[root@centos9-mtagateway ~]# cp /etc/postfix/sasl_passwd /etc/postfix/sasl_passwd.bydestination


# Si queremos credenciales dependientes del mail de origen (sender address)
# * Se puede combinar con líneas en el formato anterior, que se buscan si no está el sender listado.
# * En este caso, se busca el dominio destino.
# * Si no figura ni el sender ni el dominio destino, no se envía autenticado.

[root@centos9-mtagateway ~]# tail -1 /etc/postfix/main.cf
smtp_sender_dependent_authentication = yes


[root@centos9-mtagateway ~]# cat /etc/postfix/sasl_passwd
# sender                        username:password
client@b.com                    smtpuser@a.com:Uruguay2030


[root@centos9-mtagateway ~]# postmap /etc/postfix/sasl_passwd
[root@centos9-mtagateway ~]# cp /etc/postfix/sasl_passwd /etc/postfix/sasl_passwd.bysender

# Si además queremos usar un relayhost distinto para cada sender,
# * Se usa el relayhost global como ultimo recurso, si está configurado.
# * Si no hay relayhost global en la config, se despacha el mail al DNS-MX del dominio destino.

[root@centos9-mtagateway ~]# tail -1 /etc/postfix/main.cf
sender_dependent_relayhost_maps = hash:/etc/postfix/sender_relay

[root@centos9-mtagateway ~]# cat /etc/postfix/sender_relay
# sender                       relayhost
client@b.com                   a.com


[root@centos9-mtagateway ~]# postmap /etc/postfix/sender_relay

# Aplicamos los cambios
[root@centos9-mtagateway ~]# systemctl restart postfix


-----------
# PRUEBA DE ENVÍO
# Envío con mutt (con dirección de origen personalizada para entrar en la autenticación por sender):
[root@centos9-mtagateway ~]# cat .muttrc
set use_envelope_from = yes
set from = client@b.com


[root@centos9-mtagateway ~]# echo "Hola mundo desde mtagateway" | mutt -s "Prueba desde mtagateway" root@a.com


# Log exitoso en el server con TLS obligado y autenticado:
[root@centos9-mtaserver ~]# tail -100f /var/log/maillog
(.......................................................................)
Aug  5 14:13:58 centos9-mtaserver postfix/smtpd[2979]: connect from mtagateway.b.com[10.215.30.71]
Aug  5 14:13:58 centos9-mtaserver postfix/smtpd[2979]: 469D930BD46A: client=mtagateway.b.com[10.215.30.71], sasl_method=LOGIN, sasl_username=smtpuser@a.com
Aug  5 14:13:58 centos9-mtaserver postfix/cleanup[2983]: 469D930BD46A: message-id=<ZM6DVXu0huo2fTwW@centos9-mtagateway>
Aug  5 14:13:58 centos9-mtaserver postfix/qmgr[2806]: 469D930BD46A: from=<client@b.com>, size=588, nrcpt=1 (queue active)
Aug  5 14:13:58 centos9-mtaserver postfix/smtpd[2979]: disconnect from mtagateway.b.com[10.215.30.71] ehlo=2 starttls=1 auth=1 mail=1 rcpt=1 data=1 quit=1 commands=8
Aug  5 14:13:58 centos9-mtaserver postfix/local[2984]: 469D930BD46A: to=<root@a.com>, relay=local, delay=0.02, delays=0.01/0.01/0/0, dsn=2.0.0, status=sent (delivered to mailbox)
Aug  5 14:13:58 centos9-mtaserver postfix/qmgr[2806]: 469D930BD46A: removed
